<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Traffic Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="amir farrahi" >

    <!-- Le styles -->
<link rel="stylesheet" href="css/bootstrap.min.css" 
integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
     <link rel="stylesheet" href="css/style.css">
<script>    if (sessionStorage.getItem('userinfo') == null) {
        window.location.replace("login.html");
       };
</script>
  


    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../assets/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
  
  </head>

  <body>


  
    <div class="container">
    <div class="row">
    
    
    
<div class="col-md-3"><span class="label label-success">User Name:</span>
<span id="username" ></span>
</div> 
<div class="col-md-3"><span class="label label-default"> Condition:</span>  &nbsp;&nbsp;
<span id="contxt" ><strong></strong></span>
</div> 
<div class="col-md-3"><span class="label label-default">Budget:</span>
<span id="budget" ><strong></strong></span>
</div> 
<div class="col-md-3"><span class="label label-default">Cost:</span>
<span id="cost" ><strong></strong></span>
</div>
    </div>
        <div class="top-buffer row">
<div class="col-md-3"><span class="label label-info">Origin:</span>
  <div class="dropdown">
    <button id="srcbtn" class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">Select
    <span class="caret"></span></button>
    <ul id="srcmenu" class="dropdown-menu scrollable-menu" role="menu" >
    </ul>
    </div>
</div> 
<div class="col-md-3"><span class="label label-info">Destination:</span>
  <div class="dropdown">
    <button id="desbtn" class="btn btn-default dropdown-toggle" type="button"  data-toggle="dropdown">Select
    <span class="caret"></span></button>
    <ul id="desmenu" class="dropdown-menu scrollable-menu" role="menu" >
    </ul>
    </div>
</div> 
<div class="col-md-3"><span class="label label-info">Travel Time:</span>
<span id="traveltime" ><strong></strong></span>
</div> 
<div class="col-md-3">

  <button id="showusers" type="button" class="btn btn-primary">players location</button>
<div id='somediv'></div>
  <button id="qprompt" type="button" class="btn btn-primary hidden" data-toggle="modal" data-target="#myModal" data-backdrop="static" data-keyboard="false" data-whatever="@mdo">Open modal for @mdo</button>
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">


          </button>
          <h4 class="modal-title" id="QuestionLabel"></h4>
        </div>
        <div class="modal-body">
          <form>
             <div id="answergrp" class="form-group">


            </div>
          </form>
        </div>
        <div class="modal-footer">
        <p id="prompterr" class="text-left"></p>
          <button id="answerbtn" type="button" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>

</div> 


</div>
<div class="top-buffer row">
<div  class="col-md-4">
<span class="label label-success">Travel Mode:</span>
<div id="tmbtn" class="btn-group" role="group">
  <button data-tmid="1" id="car" type="button" class="btn btn-default">car</button>
  <button data-tmid="2" id="bike" type="button" class="btn btn-default">bike</button>
  <button data-tmid="3" id="pb" type="button" class="btn btn-default">public transport</button>
</div>
</div>
<div class="col-md-2">
<button id="startbtn" class="btn btn-default" type="button" >Go!</button>
</div>
<div class="col-md-6">

<span class="label label-warning">Traffic Info:</span>


  <span id="trafficnews" class="label label-danger" ><strong></strong></span>


</div>
</div>

<div class="top-buffer row">
<div id="gmap" class="col-md-12 map"></div>
<div id="animation" class="col-md-12 hidden"><img id="ride" class="center-block" src="" ></div>
</div>






        

    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->


<script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
   <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDVHCSIgYfsYUdCjpevjf00e0RsOyAAvDY&callback=initMap"
    async defer></script>
    <script src="js/markerwithlabel.js"></script>

      <script>
    
var map;
var myLatlng;
var srcmyLatlng;
var desmyLatlng;
var desmarker;
var srcmarker;
var conditionid,tm;
var gameid=-1;
var qid=-1;
var trafficnews="";
var anid=-1;
var antext="";
var antype="";
var budget=400;
var cost=0;
var traveltime=0;
var index=0;
var nextnode;
var tmimagelink;
var acclink='img/accident.jpg';
var startnode,endnode,currnode;
var directionsService;
var directionsDisplay;
var curredge=-1;
var edgeaccind=-1;
      function initMap() {
        myLatlng = new google.maps.LatLng(38.9072, -77.0369);
        map = new google.maps.Map(document.getElementById('gmap'), {
          center: myLatlng,
          zoom: 4
        });
        directionsService = new google.maps.DirectionsService;
        directionsDisplay = new google.maps.DirectionsRenderer();

        
      }

  

    $( document ).ready(function() {

       
    $("#budget").text(budget+ ' $');
    $("#trafficnews").text("no traffic news availible");
   // $("#traveltime").text(traveltime+ ' minutes');    
    
    $("#startbtn").prop("disabled",true);
    var uinfo=sessionStorage.getItem('userinfo');
    var myObject = JSON.parse(uinfo);
     $("#username").text(myObject.name);
     
   //  $("#gmap").load("map.html"); 
  //  alert(JSON.stringify(uinfo));
   // alert(myObject.auth_token);
         $.ajax({
                   url: 'http://localhost:3000/nodes',
                   dataType: 'json',
                   type: 'GET',
                   async: false,
                   headers: { 'Authorization' : myObject.auth_token       },
                   contentType: 'application/json; charset=utf-8'
               
                }).done(function(data) {

              $.each(data, function(index) {
          var   elem="<li " + "data-name='" + data[index].name + "' data-lat='" + data[index].lat + "' data-lon='" +data[index].lon + "' role='presentation'><a href='#' role='menuitem' tabindex='-1'>"+ 
         data[index].name+ "</a></li>";
//alert(elem);
         $('#desmenu').append(elem);
         $('#srcmenu').append(elem);

             });
                 })
                  .fail(function(msg) {
                  alert("failed");
                             
                  });
                  
         $.ajax({
                   url: 'http://localhost:3000/activeconditions',
                   dataType: 'json',
                   type: 'GET',
                   async: false,
                   headers: { 'Authorization' : myObject.auth_token       },
                   contentType: 'application/json; charset=utf-8'
               
                }).done(function(data) {
                   $("#contxt").text(data[0].name);
                   conditionid=data[0].id;
/*
              $.each(data, function(index) {
          var   elem="<li " + "value='" + data[index].id + "' role='presentation'><a href='#' role='menuitem' tabindex='-1'>" 
         + data[index].name+ "</a></li>";
       //   alert(elem);
         $('#conmenu').append(elem);
         
               });*/
             
                 })
                  .fail(function(msg) {
                  alert("failed");
                             
                  });                  
                  
       
       $('#myModal').on('hidden.bs.modal', function () {

        $(this).removeData();
    //     alert("hi");
})

        $('#startbtn').click(function() {

              $("#startbtn").prop("disabled",true);
            

              budget=budget-cost;
              $("#budget").text(budget+ ' $');
            
              if (index==0) {
                   $("#srcbtn").prop("disabled",true);
                   $("#desbtn").prop("disabled",true);
                   $("#conbtn").prop("disabled",true);
                   //conbtn
                   $.ajax({
                   url: 'http://localhost:3000/games',
                   dataType: 'json',
		             async : false,
                   type: 'POST',
                   contentType: 'application/json; charset=utf-8',
                   headers: { 'Authorization' : myObject.auth_token       },
                   data: JSON.stringify({ "condition_id": conditionid,"travel_mod":tm,"status":0,"origin":startnode,
                   "destination":endnode,"current_loc_type":"N","location_id":currnode , "budget": budget,"travel_time": traveltime }) 
                }).done(function(msg) {
             //   alert(JSON.stringify(msg));
                // alert(msg.id);
                   gameid=msg.id;
                   index=index+1;
    		       })
                  .fail(function(msg) {
                   alert("error");
                });
              };
                  $.ajax({
                     url: 'http://localhost:3000/games/'+ gameid,
                     dataType: 'json',
		               async : false,
                     type: 'PUT',
                     contentType: 'application/json; charset=utf-8',
                     headers: { 'Authorization' : myObject.auth_token ,  "X-HTTP-Method-Override": "PUT"    },
                     data: JSON.stringify({ "location_id": curredge ,"current_loc_type":"E","status": status}) 
                  }).done(function(msg) {
              //       alert(JSON.stringify(msg));
    		         })
                  .fail(function(msg) {
                      alert("error");
                  });
              
                  if ( conditionid !=3 || (conditionid==3 && edgeaccind==0 ) ) {
                    $("#gmap").addClass('hidden');
                    $("#animation").removeClass('hidden');
                    $('#ride').attr("src",tmimagelink);
                    setTimeout(revert, traveltime);
                  };
                  if (conditionid==3 && edgeaccind==1) {
                    $('#ride').attr("src",acclink);
                    $("#gmap").addClass('hidden');
                    $("#animation").removeClass('hidden');
                    $("#trafficnews").text("Traffic ahead be patient");
                    setTimeout(accrevert,3000)
                  
                  }
                          
       });       
                  
       $('#desmenu li').click(function() {
       if (desmarker!=null) desmarker.setMap(null);

          var lat=parseFloat(this.getAttribute("data-lat"));
          var lon=parseFloat(this.getAttribute("data-lon"));

          desmyLatlng = new google.maps.LatLng(lat,lon);
          desmarker = new google.maps.Marker({
          position: desmyLatlng,
          title:this.getAttribute("data-name"),
          icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=' + this.getAttribute("data-name") + '|FF0000|000000'
       
          });
          desmarker.setMap(map); 
          $("#desbtn").text(this.getAttribute("data-name")); 
          endnode=this.getAttribute("data-name");
       });
       
       $('#srcmenu li').click(function() {
       if (srcmarker!=null) srcmarker.setMap(null);

          var lat=parseFloat(this.getAttribute("data-lat"));
          var lon=parseFloat(this.getAttribute("data-lon"));

          srcmyLatlng = new google.maps.LatLng(lat,lon);
          srcmarker = new google.maps.Marker({
          position: srcmyLatlng,
          title:this.getAttribute("data-name"),
          icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=' + this.getAttribute("data-name") + '|FF0000|000000'
          });
          srcmarker.setMap(map);  
          $("#srcbtn").text(this.getAttribute("data-name"));
          startnode=this.getAttribute("data-name");
          currnode=startnode;
       });
      
           

       $('#showusers').click(function() {
     //    alert("test");
          window.open('map.html', 'window name', 'window settings'); 
       });
       

        function accrevert(){
          $('#ride').attr("src",tmimagelink);
          setTimeout(revert, traveltime);        
        };

        function revert(){
             
             $("#gmap").removeClass('hidden');
             $("#animation").addClass('hidden');
             $("#QuestionLabel").text("");
             $("#prompterr").text("");
             $("#answergrp").empty();
             qid=-1;
              $.ajax({
                   url: 'http://localhost:3000/nodequestion/' + currnode  ,
                   dataType: 'json',
		             async : false,
                   type: 'GET',
                   contentType: 'application/json; charset=utf-8',
                   headers: { 'Authorization' : myObject.auth_token       }
                }).done(function(msg) {
                    if (msg.question.length>0) {
                      qid=msg.question[0].id;
                      $("#QuestionLabel").text(msg.question[0].name);
                      antype=msg.question[0].answer_type; 
                      if (msg.question[0].answer_type=="T") $("#answergrp").append("<textarea class='form-control' id='message-text'></textarea>");
                      if (msg.question[0].answer_type=="M") 
                      $.each(msg.answer, function(index) {
                        $("#answergrp").append("<div class='radio'><label><input type='radio' name='optradio' value='" + msg.answer[index].id+ "'>" + msg.answer[index].answer + "</label></div>");
                      });
                   }
    		   })
                  .fail(function(msg) {
                   alert("error");
                  });
                  currnode=nextnode;
                  var status=0;
                  if (nextnode==endnode) status=1; 
                  else status=0;     
                  $.ajax({
                     url: 'http://localhost:3000/games/'+ gameid,
                     dataType: 'json',
		               async : false,
                     type: 'PUT',
                     contentType: 'application/json; charset=utf-8',
                     headers: { 'Authorization' : myObject.auth_token ,  "X-HTTP-Method-Override": "PUT"    },
                     data: JSON.stringify({ "location_id": currnode ,"status": status}) 
                  }).done(function(msg) {
              //       alert(JSON.stringify(msg));
    		         })
                  .fail(function(msg) {
                      alert("error");
                  });

                  
            if (qid!=-1) $("#qprompt").click();
            if (nextnode==endnode) {
              $('#ride').attr("src",'img/gameover.jpg');
               $("#gmap").addClass('hidden');
               $("#animation").removeClass('hidden');
               $("#tmbtn button").prop("disabled",true);
                          
            }
        }
         
  
         
       $("#tmbtn button").click(function() {
          
          
          tm=this.getAttribute("data-tmid") ;  

           if (tm==1) { gtm=google.maps.DirectionsTravelMode.DRIVING;
                        tmimagelink='img/car.gif';
                        //$('#ride').attr("src",'img/car.gif');
           }
           if (tm==2) { gtm=google.maps.DirectionsTravelMode.BICYCLING;
           					//$('#ride').attr("src",'img/bike.jpg');
           					tmimagelink='img/bike.jpg';
           					
           }
           if (tm==3) { gtm=google.maps.DirectionsTravelMode.TRANSIT;
                        //$('#ride').attr("src",'img/bus.gif');
                        tmimagelink='img/bus.gif';           
           }
        //   alert(startnode);
        //   alert (currnode);
                  $.ajax({
                   url: 'http://localhost:3000/getroute',
                   dataType: 'json',
		             async : false,
                   type: 'POST',
                   contentType: 'application/json; charset=utf-8',
                   data: JSON.stringify({ "condition_id": conditionid,"travel_mod":tm,"status":0,"origin":currnode,
                   "destination":endnode,"current_loc_type":"N","location_id":currnode  }),
                   headers: { 'Authorization' : myObject.auth_token       } 
          }).done(function(msg) {
                //   alert(JSON.stringify(msg));
                    var start,end;
                    var lat,lon;
                    var waypts=[];
                    $("#traveltime").text('');
                    if (msg.traveltime!=null) {
                      traveltime=msg.traveltime;
                      $("#traveltime").text(traveltime+ ' minutes');
                    }
                    $("#cost").text('');
                    if (msg.cost!=null) { 
                      cost=msg.cost;
                      $("#cost").text(cost+ ' $');
                    }
                    if (msg.comingedge!=null) {
                       curredge= msg.comingedge;
                       edgeaccind=msg.accind;
                    }
                    
                    
                    if (msg.wp.length!=0) { 
                    		$("#startbtn").prop("disabled",false);
                    		nextnode=msg.wp[1].name;
                    		for (var i = 0; i < msg.wp.length; i++){
                          lat=msg.wp[i].location[0];
                          lon=msg.wp[i].location[1];
                          var gpoint=new google.maps.LatLng(lat, lon);
                          waypts.push({location:gpoint,stopover:false}); 
                          if (i==0)               start = new google.maps.LatLng(lat, lon);
                          if (i==msg.wp.length-1) end = new google.maps.LatLng(lat, lon);
                        }
                        directionsDisplay.setDirections({routes: []});
                        calculateAndDisplayRoute(directionsService,directionsDisplay,start,end,waypts,gtm);
                    }
                    else $("#startbtn").prop("disabled",true);
             
                   
    		 })
          .fail(function(msg) {
                    alert("fail");
          });
       
       
       });
       
       
       function calculateAndDisplayRoute(directionsService, directionsDisplay, pointA, pointB,mywaypoints,travel_mode) {
         directionsDisplay.setMap(map);
         directionsService.route({
         origin: pointA,
         destination: pointB,
         waypoints:mywaypoints,
         travelMode: travel_mode //google.maps.TravelMode.DRIVING
         }, function(response, status) {
              if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
              } /*else {
              window.alert('Directions request failed due to ' + status);
              }*/
           });
      }       
       
        
       $('#answerbtn').click(function() {
        if ( antype=="M") { antext=""; 
                              anid=$('input[name=optradio]:checked', '#answergrp').val();
                              if ( typeof anid == 'undefined' ) 
                              anid=-1;         
          }
          if ( antype=="T") { anid=-1; antext=$("#message-text").val().trim();}
          if (anid==-1 && antext=="") {$("#prompterr").text("please answer");
            return;          
          }
          else {$('#myModal').modal('toggle');}  
              $.ajax({
                   url: 'http://localhost:3000/userfeeds',
                   dataType: 'json',
		             async : false,
                   type: 'POST',
                   contentType: 'application/json; charset=utf-8',
                   data: JSON.stringify({ "game_id": gameid, "question_id": qid,"answer_id":anid ,"usert":antext}),
                   headers: { 'Authorization' : myObject.auth_token       } 
          }).done(function(msg) {
                 //   alert(JSON.stringify(msg));
                   
    		 })
          .fail(function(msg) {
                    alert(JSON.stringify(msg));
          });
      

      });
        
        
          
 
});

     
  
    </script>    
  </body>
</html>
